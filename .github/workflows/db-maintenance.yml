name: Database Maintenance

on:
  schedule:
    - cron: '0 2 1 * *'  # ë§¤ì›” 1ì¼ ìƒˆë²½ 2ì‹œ (KST 11ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      dry_run:
        description: 'Dry run mode (true/false)'
        required: false
        default: 'true'
      months_to_keep:
        description: 'Months to keep'
        required: false
        default: '6'

jobs:
  maintain-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install oracledb

      - name: Run Database Maintenance
        env:
          ORACLE_DB_USER: ${{ secrets.ORACLE_DB_USER }}
          ORACLE_DB_PASSWORD: ${{ secrets.ORACLE_DB_PASSWORD }}
          ORACLE_DB_DSN: ${{ secrets.ORACLE_DB_DSN }}
          ORACLE_WALLET_BASE64: ${{ secrets.ORACLE_WALLET_BASE64 }}
          USE_ORACLE_DB: ${{ secrets.USE_ORACLE_DB }}
          DB_ARCHIVE_MONTHS: ${{ github.event.inputs.months_to_keep || '6' }}
        run: |
          # Dry run vs ì‹¤ì œ ì‹¤í–‰
          if [ "${{ github.event.inputs.dry_run }}" == "false" ]; then
            python scripts/db_maintenance.py --apply
          else
            python scripts/db_maintenance.py
          fi

      - name: Send Telegram notification
        if: always()
        run: |
          # ìœ ì§€ë³´ìˆ˜ ê²°ê³¼ í…”ë ˆê·¸ë¨ ì•Œë¦¼
          if [ ${{ job.status }} == 'success' ]; then
            MESSAGE="âœ… <b>DB ìœ ì§€ë³´ìˆ˜ ì™„ë£Œ</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A%0AğŸ“Š Oracle DB ì •ë¦¬ ì™„ë£Œ%0AğŸ”§ ì˜¤ë˜ëœ ë°ì´í„° ì•„ì¹´ì´ë¹™ ì„±ê³µ"
          else
            MESSAGE="âŒ <b>DB ìœ ì§€ë³´ìˆ˜ ì‹¤íŒ¨</b>%0Aâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”%0A%0Aâš ï¸ ìœ ì§€ë³´ìˆ˜ ì¤‘ ì˜¤ë¥˜ ë°œìƒ%0AğŸ“‹ GitHub Actions ë¡œê·¸ í™•ì¸ í•„ìš”"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=HTML"
