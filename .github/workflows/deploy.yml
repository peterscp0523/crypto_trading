name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: crypto-trading-bot
  DOCKER_TAG: latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build and transfer Docker image
        run: |
          # Docker 이미지 빌드
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .

          # Docker 이미지를 tar로 저장
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} | gzip > crypto-bot.tar.gz

          # 파일 크기 확인
          ls -lh crypto-bot.tar.gz

          # SSH 키 설정
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/oracle_key
          chmod 600 ~/.ssh/oracle_key

          # SCP로 파일 전송
          scp -i ~/.ssh/oracle_key -o StrictHostKeyChecking=no \
            crypto-bot.tar.gz ${{ secrets.ORACLE_USERNAME }}@${{ secrets.ORACLE_HOST }}:/tmp/

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USERNAME }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            # Wallet 디렉토리 준비 (Oracle DB 사용 시)
            mkdir -p /tmp/wallet

            # Wallet 파일 디코딩 및 압축 해제 (Python 사용, unzip 불필요)
            if [ -n "${{ secrets.ORACLE_WALLET_BASE64 }}" ]; then
              echo "${{ secrets.ORACLE_WALLET_BASE64 }}" | base64 -d > /tmp/wallet.zip
              python3 -c 'import zipfile; zipfile.ZipFile("/tmp/wallet.zip").extractall("/tmp/wallet")'
              rm /tmp/wallet.zip
              echo "✅ Oracle Wallet 설정 완료"
            fi

            # Docker 이미지 로드 (압축 해제하면서)
            gunzip -c /tmp/crypto-bot.tar.gz | docker load

            # 기존 컨테이너 중지 및 제거
            docker stop crypto-trading-bot || true
            docker rm crypto-trading-bot || true

            # 새 컨테이너 실행
            docker run -d \
              --name crypto-trading-bot \
              --restart unless-stopped \
              -v /tmp/wallet:/app/wallet \
              -e UPBIT_ACCESS_KEY="${{ secrets.UPBIT_ACCESS_KEY }}" \
              -e UPBIT_SECRET_KEY="${{ secrets.UPBIT_SECRET_KEY }}" \
              -e TELEGRAM_TOKEN="${{ secrets.TELEGRAM_TOKEN }}" \
              -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -e MARKET="${{ secrets.MARKET }}" \
              -e CHECK_INTERVAL="${{ secrets.CHECK_INTERVAL }}" \
              -e ENABLE_MULTI_COIN="true" \
              -e USE_ORACLE_DB="${{ secrets.USE_ORACLE_DB }}" \
              -e ORACLE_DB_USER="${{ secrets.ORACLE_DB_USER }}" \
              -e ORACLE_DB_PASSWORD="${{ secrets.ORACLE_DB_PASSWORD }}" \
              -e ORACLE_DB_DSN="${{ secrets.ORACLE_DB_DSN }}" \
              -e ORACLE_WALLET_PASSWORD="${{ secrets.ORACLE_WALLET_PASSWORD }}" \
              -e TNS_ADMIN="/app/wallet" \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}

            # 정리
            rm /tmp/crypto-bot.tar.gz

            # 오래된 이미지 정리
            docker image prune -f

            # 로그 확인
            echo "=== Container Status ==="
            docker ps -a | grep crypto-trading-bot
            echo "=== Recent Logs ==="
            docker logs --tail 50 crypto-trading-bot

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
