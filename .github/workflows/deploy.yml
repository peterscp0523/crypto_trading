name: Deploy to Oracle Cloud

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  DOCKER_IMAGE: crypto-trading-bot
  DOCKER_TAG: latest

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub (optional)
        if: ${{ secrets.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} .
          docker save ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }} -o crypto-bot.tar

      - name: Copy files to Oracle Cloud
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USERNAME }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          source: "crypto-bot.tar"
          target: "/tmp"

      - name: Deploy to Oracle Cloud
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ORACLE_HOST }}
          username: ${{ secrets.ORACLE_USERNAME }}
          key: ${{ secrets.ORACLE_SSH_KEY }}
          script: |
            # Docker 이미지 로드
            docker load -i /tmp/crypto-bot.tar

            # 기존 컨테이너 중지 및 제거
            docker stop crypto-trading-bot || true
            docker rm crypto-trading-bot || true

            # 새 컨테이너 실행
            docker run -d \
              --name crypto-trading-bot \
              --restart unless-stopped \
              -e UPBIT_ACCESS_KEY="${{ secrets.UPBIT_ACCESS_KEY }}" \
              -e UPBIT_SECRET_KEY="${{ secrets.UPBIT_SECRET_KEY }}" \
              -e TELEGRAM_TOKEN="${{ secrets.TELEGRAM_TOKEN }}" \
              -e TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -e MARKET="${{ secrets.MARKET }}" \
              -e CHECK_INTERVAL="${{ secrets.CHECK_INTERVAL }}" \
              ${{ env.DOCKER_IMAGE }}:${{ env.DOCKER_TAG }}

            # 정리
            rm /tmp/crypto-bot.tar

            # 오래된 이미지 정리
            docker image prune -f

            # 로그 확인
            echo "=== Container Status ==="
            docker ps -a | grep crypto-trading-bot
            echo "=== Recent Logs ==="
            docker logs --tail 50 crypto-trading-bot

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
          fi
